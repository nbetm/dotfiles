#!/usr/bin/env bash
# vim: set ft=bash :
#
# ------------------------------------------------------------------------------
# BASHRC - Interactive Shell Configuration
# ------------------------------------------------------------------------------
# Sourced by: Interactive shells (via bash_profile for login, directly for non-login)
# Purpose: Shell options, tool initialization, ble.sh setup
# ------------------------------------------------------------------------------

# Exit if not interactive
[[ $- != *i* ]] && return

# ------------------------------------------------------------------------------
# ble.sh - Bash Line Editor (attach early)
# ------------------------------------------------------------------------------

# shellcheck disable=SC1091
if [[ -f "${XDG_DATA_HOME:-$HOME/.local/share}/blesh/ble.sh" ]]; then
    source "${XDG_DATA_HOME:-$HOME/.local/share}/blesh/ble.sh" --attach=none
fi

# ------------------------------------------------------------------------------
# Shell Options
# ------------------------------------------------------------------------------

# Navigation
shopt -s autocd      # cd into directory by typing its name
shopt -s cdspell     # Autocorrect typos in cd
shopt -s dirspell    # Autocorrect directory names during completion
shopt -s cdable_vars # cd into variable values

# Globbing
shopt -s extglob    # Extended pattern matching
shopt -s globstar   # ** matches all files and directories recursively
shopt -s nocaseglob # Case-insensitive globbing
shopt -s dotglob    # Include hidden files in glob

# History
shopt -s histappend # Append to history instead of overwriting
shopt -s cmdhist    # Save multi-line commands as single entry

# Misc
shopt -s checkwinsize            # Update LINES and COLUMNS after each command
shopt -s no_empty_cmd_completion # Don't complete on empty line

# ------------------------------------------------------------------------------
# Tool Initialization
# ------------------------------------------------------------------------------

# FZF
# shellcheck disable=SC1091
if [[ -n "${FZF_SHELL_DIR:-}" && -f "${FZF_SHELL_DIR}/key-bindings.bash" ]]; then
    # Note: When using ble.sh, FZF is loaded via blesh-contrib instead
    # This is a fallback for non-ble.sh sessions
    if [[ -z "${BLE_VERSION:-}" ]]; then
        source "${FZF_SHELL_DIR}/key-bindings.bash"
        source "${FZF_SHELL_DIR}/completion.bash"
    fi
fi

# Direnv
if command -v direnv &>/dev/null; then
    eval "$(direnv hook bash)"
fi

# Starship prompt
if command -v starship &>/dev/null; then
    eval "$(starship init bash)"
fi

# ------------------------------------------------------------------------------
# Bash Completion (lazy-loads from Homebrew/system dirs)
# ------------------------------------------------------------------------------

# shellcheck disable=SC1091
if [[ -f "${HOMEBREW_PREFIX}/etc/profile.d/bash_completion.sh" ]]; then
    source "${HOMEBREW_PREFIX}/etc/profile.d/bash_completion.sh"
elif [[ -f /usr/share/bash-completion/bash_completion ]]; then
    source /usr/share/bash-completion/bash_completion
fi

# AWS (not in bash-completion, uses built-in completer)
command -v aws_completer &>/dev/null && complete -C aws_completer aws

# ------------------------------------------------------------------------------
# Source Includes
# ------------------------------------------------------------------------------

if [[ -d "${HOME}/.bash/includes" ]]; then
    for file in "${HOME}"/.bash/includes/*.sh; do
        # shellcheck disable=SC1090
        [[ -f "$file" ]] && source "$file"
    done
fi

# ------------------------------------------------------------------------------
# Zoxide (must be near the end per zoxide docs)
# ------------------------------------------------------------------------------

if command -v zoxide &>/dev/null; then
    eval "$(zoxide init bash)"
fi

# ------------------------------------------------------------------------------
# ble.sh - Attach (must be at the end)
# ------------------------------------------------------------------------------

# shellcheck disable=SC2154
[[ ${BLE_VERSION-} ]] && ble-attach
