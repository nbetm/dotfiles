#!/usr/bin/env bash
# vim: set ft=bash :
#
# Login Shell Configuration
# Sourced by: LOGIN shells only (SSH, terminal launch, explicit bash -l)

# Guard against re-sourcing
[[ -n "$_BASH_PROFILE_SOURCED" ]] && return
_BASH_PROFILE_SOURCED=1

# ------------------------------------------------------------------------------
# XDG Base Directories
# ------------------------------------------------------------------------------

export XDG_CONFIG_HOME="${HOME}/.config"
export XDG_BIN_HOME="${HOME}/.local/bin"
export XDG_DATA_HOME="${HOME}/.local/share"
export XDG_CACHE_HOME="${HOME}/.cache"

# ------------------------------------------------------------------------------
# Platform Detection
# ------------------------------------------------------------------------------

OS_NAME=$(uname -s)
OS_ARCH=$(uname -m)
export OS_NAME OS_ARCH

if [[ "$OS_NAME" == "Linux" ]]; then
    OS_DISTRO=$(grep '^ID=' /etc/os-release 2>/dev/null | cut -d'=' -f2 | tr -d '"'\' | tr '[:upper:]' '[:lower:]' || echo "unknown")
else
    OS_DISTRO=
fi
export OS_DISTRO

# ------------------------------------------------------------------------------
# PATH Configuration
# ------------------------------------------------------------------------------

if [[ $OS_NAME == "Darwin" ]]; then
    # Homebrew
    if [[ $OS_ARCH == "arm64" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    else
        eval "$(/usr/local/bin/brew shellenv)"
    fi

    # Additional paths (prepend to PATH)
    path_prepend=(
        "${HOME}/.local/bin"
        "${XDG_DATA_HOME}/google-cloud-sdk/bin"
        "${HOMEBREW_PREFIX}/opt/coreutils/libexec/gnubin"
        "${HOMEBREW_PREFIX}/opt/curl/bin"
        "${HOMEBREW_PREFIX}/opt/findutils/libexec/gnubin"
        "${HOMEBREW_PREFIX}/opt/gnu-indent/libexec/gnubin"
        "${HOMEBREW_PREFIX}/opt/gnu-sed/libexec/gnubin"
        "${HOMEBREW_PREFIX}/opt/gnu-tar/libexec/gnubin"
        "${HOMEBREW_PREFIX}/opt/gnu-which/libexec/gnubin"
        "${HOMEBREW_PREFIX}/opt/grep/libexec/gnubin"
        "${HOMEBREW_PREFIX}/opt/make/libexec/gnubin"
        "${HOMEBREW_PREFIX}/opt/fzf/bin"
    )

    for p in "${path_prepend[@]}"; do
        [[ -d "$p" && ":$PATH:" != *":$p:"* ]] && PATH="$p:$PATH"
    done
    unset path_prepend p

    export FZF_SHELL_DIR="${HOMEBREW_PREFIX}/opt/fzf/shell"

elif [[ $OS_NAME == "Linux" ]]; then
    if [[ "$OS_DISTRO" == "nixos" ]]; then
        # NixOS: Packages managed via Nix, minimal PATH additions
        export FZF_SHELL_DIR="/run/current-system/sw/share/fzf"
    else
        # Debian/Ubuntu: Manual package installations
        path_prepend=(
            "${HOME}/.local/bin"
            "${XDG_DATA_HOME}/google-cloud-sdk/bin"
            "${HOME}/.fzf/bin"
            "/usr/libexec/docker/cli-plugins"
        )

        for p in "${path_prepend[@]}"; do
            [[ -d "$p" && ":$PATH:" != *":$p:"* ]] && PATH="$p:$PATH"
        done
        unset path_prepend p

        export FZF_SHELL_DIR="${HOME}/.fzf/shell"
    fi

    # Docker Rootless
    export DOCKER_HOST=unix:///run/user/1000/docker.sock
fi

export PATH

# ------------------------------------------------------------------------------
# LS_COLORS
# ------------------------------------------------------------------------------

if [[ -f "${HOME}/.dir_colors" ]]; then
    eval "$(dircolors -b "${HOME}/.dir_colors")"
fi

# ------------------------------------------------------------------------------
# Environment Variables
# ------------------------------------------------------------------------------

export EDITOR="hx"
export VISUAL="hx"
export PAGER="less"
export LANG=en_US.UTF-8

# Less options
export LESS="-F -g -i -M -R -S -w -X -z-4"

# History
export HISTFILE="${HOME}/.bash_history"
export HISTSIZE=10000
export HISTFILESIZE=10000
export HISTCONTROL=ignoreboth:erasedups
export HISTIGNORE="ls:ll:cd:pwd:exit:clear:history"

# FZF Color Scheme | Nord Deep
export FZF_DEFAULT_OPTS='
    --color=fg:#b8c5d1,fg+:#b8c5d1,bg:#212732,bg+:#3b4252
    --color=hl:#88c0d0,hl+:#88c0d0,info:#798094,marker:#b48ead
    --color=prompt:#a3be8c,spinner:#ebcb8b,pointer:#88c0d0,header:#81a1c1
    --color=border:#3b4252,label:#b8c5d1,query:#b8c5d1
    --border="rounded" --border-label="" --preview-window="border-rounded" --prompt="❱ "
    --marker="❱" --pointer="❱" --separator="─" --scrollbar="│"'

# AWS
export AWS_SDK_LOAD_CONFIG=true
export AWS_PAGER=""

# Cheat
export CHEAT_USE_FZF=true

# Google Cloud SDK
export CLOUDSDK_PYTHON="${HOME}/.local/bin/python3.12"

# Man pager with bat
export MANPAGER="sh -c 'sed -u -e \"s/\\x1B\[[0-9;]*m//g; s/.\\x08//g\" | bat -p -lman'"

# Libvirt
export LIBVIRT_DEFAULT_URI=qemu:///system

# Truecolor
export COLORTERM=truecolor

# PDSH
export PDSH_RCMD_TYPE=ssh

# ------------------------------------------------------------------------------
# Source bashrc for interactive shell setup
# ------------------------------------------------------------------------------

# shellcheck source=dot-bashrc
[[ -f "${HOME}/.bashrc" ]] && source "${HOME}/.bashrc"
